# core 改善計画

## 目的
- `ActorContext` でのネストした非同期ロックを解消し、自己デッドロックを防ぐ。
- メトリクスおよびユーザーコード呼び出し前に必ずロックを解放する構造に改修する。
- `ExtendedPid::ref_process` のロック保持時間を短縮し、`ProcessRegistry` 参照時のデッドロックを除去する。
- 変更後の挙動を自動テストで検証し、安全性を担保する。

## タスク一覧
1. `ActorContext` の補助ロック (`extras` / `message_or_envelope`) 取得処理を分離し、`MutexGuard` を待機中に保持しないようにする。（完了）
2. `ActorContext` のコールバック実行箇所を洗い出し、ロック解放後にユーザーコード・メトリクス処理を行うよう再配置する。（完了）
3. `ExtendedPid::ref_process` のキャッシュ取得と `ProcessRegistry` 呼び出しを分離し、二段階ロックに変更する。（完了）
4. 危険なパスを対象にしたリグレッションテスト（ユニット/統合）を整備し、`cargo test -p nexus-actor-core-rs` を実行して退行を防ぐ。（完了）

## 進捗状況
- [x] 既存コードのロック構造を調査し、問題箇所を特定。
- [x] `ActorContext` のロック分離実装。
- [x] `ExtendedPid::ref_process` の再設計と実装。
- [x] テスト実行および結果記録。

## リスクと対応策
- **広範囲な変更による副作用**: 影響範囲を単体テストでカバーし、レビュー時に並行性の観点で再確認する。
- **メトリクス拡張との整合性**: 既存 API 互換性を維持しつつ、再入可能性を手動テストで確認する。
- **非同期ロックの取り違え**: `Arc<RwLock<_>>` など補助ロックの取得はヘルパー関数経由に統一し、保守性を高める。

## 次のアクション
- `ActorContext` にヘルパーを追加してロック解放を明示化し、関連メソッドを順次改修する。
- `ExtendedPid::ref_process` にキャッシュ判定用のヘルパーを導入し、取得・更新フェーズを分離する。
- 変更後に `cargo fmt` → `cargo test -p nexus-actor-core-rs` を実行して挙動を確認する。
