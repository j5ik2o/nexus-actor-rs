# nexus-actor-rs リファクタリング実行計画

作成日: 2025/01/27

## 完了したタスク

### ✅ フェーズ1: 依存関係の可視化と分析
- モジュール構造の分析完了（`core_dependency_analysis.md`に記録）
- 循環依存の特定：core ⇄ context の相互依存
- リファクタリング優先順位の決定

### ✅ フェーズ2: テスト環境の確認
- 全テストが正常に動作することを確認（82件のテスト全てパス）
- カバレッジレポートの生成設定完了

## 現在の作業: 循環依存の解消

### 問題の詳細
coreモジュールとcontextモジュールが相互に依存している：
- `core` → `context`: Actor, Props, ActorHandleがContextHandleを使用
- `context` → `core`: ActorContextがActor, Props, ExtendedPidを使用

### 解決方針
1. 共通のトレイトを新しい`traits`モジュールに抽出
2. coreとcontextの両方がtraitsに依存するよう変更
3. 依存の方向を一方向に統一

### 実装手順

#### ステップ1: traitsモジュールの作成
```
core/src/
├── traits/
│   ├── mod.rs
│   ├── actor_traits.rs      # Actorトレイトなど
│   ├── context_traits.rs    # ContextHandleトレイトなど
│   └── handle_traits.rs     # 各種ハンドルトレイト
```

#### ステップ2: トレイトの移動
1. `Actor`トレイトを`traits/actor_traits.rs`に移動
2. `ContextHandle`トレイトを`traits/context_traits.rs`に移動
3. その他の共通トレイトを適切なファイルに移動

#### ステップ3: インポートの更新
1. coreモジュール内のインポートを更新
2. contextモジュール内のインポートを更新
3. 他のモジュールからのインポートを更新

#### ステップ4: テストの実行と修正
1. 各ステップごとにテストを実行
2. 壊れたテストを修正
3. 新しい構造でテストが全て通ることを確認

## 次のステップ

### 短期目標（今週）
- [ ] traitsモジュールの実装
- [ ] 循環依存の完全な解消
- [ ] テストの更新と確認

### 中期目標（2週間）
- [ ] テストコードの分離（フェーズ2の残り）
- [ ] 基本モジュールのリファクタリング（フェーズ3）
- [ ] パフォーマンステストの実施

### 長期目標（1ヶ月）
- [ ] アクターモジュールのリファクタリング（フェーズ4）
- [ ] ディスパッチとミドルウェアのリファクタリング（フェーズ5）
- [ ] 型付きアクターのリファクタリング（フェーズ6）

## 注意事項

1. **段階的な実装**: 各変更は小さく、テスト可能な単位で実施
2. **後方互換性**: 公開APIの変更は最小限に
3. **ドキュメント**: 各変更について適切にドキュメント化
4. **パフォーマンス**: リファクタリング前後でパフォーマンスを測定

## 成功の基準

- 全てのテストが通過
- 循環依存が解消される
- コードの可読性が向上
- 新機能の追加が容易になる